<!doctype html>
<html lang="en">
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Go Game!</title>
<script>

var state = null;
var ws = null;
function wsStarup() {
    var mws = new WebSocket("ws://" + window.location.host + "/ws");
    mws.onopen = function (e) {
        ws = mws;
        //console.log('open', e)
        ws.send(JSON.stringify({type: 'debug', data: 'yo!'}));
    }
    mws.onmessage = function (e) {
        let m = JSON.parse(e.data);
        if (m.type == "id") {
            me = m.data.id;
        } else if (m.type == "state") {
            state = m.data;
        } else if (m.type == "reload") {
            location.reload();
        } else {
            console.log("unknow message", m);
        }
    }
    mws.onclose = function (e) {
        setTimeout(wsStarup, 1000);
    }
}

let map = {
    0: "forrest.png",
    1: "player.png",
    2: "bad-grass.png"
};

let imageMap = { };
function initImageMap() {
    Object.keys(map).forEach((k) => {
        const img = new Image();
        img.onload = () => imageMap[k] = img;
        img.src = map[k];
    });
}

function drawRotated(canvas, ctx, image, angle, x, y) {
    var width = image.width;
    var height = image.height;

    ctx.translate(x, y);
    ctx.rotate(angle * -Math.PI/2);
    ctx.drawImage(image, -width / 2, -height / 2, width, height);
    ctx.rotate(angle * Math.PI/2);
    ctx.translate(-x, -y);
}
function draw() {
    let canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");
    if (state) {
        state.map.forEach((row,y) => row.forEach((e,x) => {
            if (e.id in imageMap) {
                drawRotated(canvas,ctx,imageMap[e.id], e.rot, 32 + 64 * x, 32 + 64 * y);
            }
        }));
    }
    requestAnimationFrame(() => draw());
}

function myInput(inn) {
    ws.send(JSON.stringify({type:"input", data: inn}));
}

var keys = {
    'KeyA': 'left',
    'KeyS': 'down',
    'KeyD': 'right',
    'KeyW': 'up'
};

function keyboardStarup() {
    document.addEventListener('keydown', (e) => {
        if (e.code in keys && e.repeat == false) {
            myInput(keys[e.code]);
        }
    });
}


function myStartup() {
    initImageMap();
    keyboardStarup();
    wsStarup();
    draw();
}

window.addEventListener("load", myStartup, false);

</script>
</head>
<body>
<div style="
    display: flex; 
    flex-direction: column;
">
    <canvas id="canvas" style="width: 320px; height: 320px" width="320" height="320" ></canvas>
    <div>
        <button onclick="myInput('up')">up</button>
        <button onclick="myInput('down')">down</button>
        <button onclick="myInput('left')">left</button>
        <button onclick="myInput('right')">right</button>
    </div>
</div>
</body>
</html>
